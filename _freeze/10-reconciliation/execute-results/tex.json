{
  "hash": "2dcb7bf7aa2bc53e4348fe861672b1a7",
  "result": {
    "markdown": "---\ntitle: \"Time Series Analysis & Forecasting Using R\"\nsubtitle: \"10. Forecast reconciliation\"\n---\n\n\n## Outline\n\n\\vspace*{0.7cm}\\tableofcontents\n\n\n\n\n\n# Hierarchical and grouped time series\n\n## Australian Pharmaceutical Benefits Scheme\n\n\\full{pills}\n\n## PBS sales\n\\fontsize{9}{10}\\sf\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPBS\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 67,596 x 9 [1M]\n# Key:       Concession, Type, ATC1, ATC2 [336]\n      Month Concession   Type   ATC1  ATC1_desc ATC2  ATC2_desc Scripts\n      <mth> <chr>        <chr>  <chr> <chr>     <chr> <chr>       <dbl>\n 1 1991 Jul Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   18228\n 2 1991 Aug Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   15327\n 3 1991 Sep Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   14775\n 4 1991 Oct Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   15380\n 5 1991 Nov Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   14371\n 6 1991 Dec Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   15028\n 7 1992 Jan Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   11040\n 8 1992 Feb Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   15165\n 9 1992 Mar Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   16898\n10 1992 Apr Concessional Co-pa~ A     Alimenta~ A01   STOMATOL~   18141\n# i 67,586 more rows\n# i 1 more variable: Cost <dbl>\n```\n:::\n:::\n\n\n\n\n## ATC drug classification\n\\fontsize{12}{13}\\sf\n\n\\hspace*{-0.5cm}\\begin{tabular}{lp{10.7cm}}\nA &Alimentary tract and metabolism\\\\\nB &Blood and blood forming organs\\\\\nC &Cardiovascular system\\\\\nD &Dermatologicals\\\\\nG &Genito-urinary system and sex hormones\\\\\nH &Systemic hormonal preparations, excluding sex hormones and insulins\\\\\nJ &Anti-infectives for systemic use\\\\\nL &Antineoplastic and immunomodulating agents\\\\\nM &Musculo-skeletal system\\\\\nN &Nervous system\\\\\nP &Antiparasitic products, insecticides and repellents\\\\\nR &Respiratory system\\\\\nS &Sensory organs\\\\\nV &Various\n\\end{tabular}\n\n## ATC drug classification\n\\hspace*{-1.5cm}\\begin{minipage}{9.6cm}\n\\begin{tikzpicture}\n\\tikzstyle{every node}=[ellipse,font=\\small,draw,fill=red!15]\n\\tikzstyle[level font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 1}=[font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 2}=[font=\\small,set style={{every node}+=[fill=yellow]}]\n\\node[label=right:\\hspace*{-0.cm}Alimentary tract and metabolism,label=left:\\textbf{ATC1: 14 classes}\\hspace*{0.3cm}]{A}[edge from parent fork down]\n   child {node[label=right:\\hspace*{-0.0cm}Drugs used in diabetes,label=left:\\textbf{ATC2: 84 classes}]{A10}\n     child {node[label=right:\\hspace*{-0.35cm}Blood glucose lowering drugs]{A10B}\n       child {node[label=right:\\hspace*{0.1cm}Biguanides]{A10BA}\n         child {node[label=right:\\hspace*{-0.15cm}Metformin]{A10BA02}\n }}}};\n \\end{tikzpicture}\n\\end{minipage}\n\n## Hierarchical time series\n\\fontsize{13}{14}\\sf\n\nA \\alert{\\textbf{hierarchical time series}} is a collection of several time series that are linked together in a hierarchical structure.\n\n\\begin{minipage}{9.6cm}\n\\begin{block}{}\n\\begin{tikzpicture}\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]\n\\tikzstyle[level distance=.1cm]\n\\tikzstyle[sibling distance=7cm]\n\\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AA}}\n   child {node {AB}}\n   child {node {AC}}\n }\n child {node {B}\n   child {node {BA}}\n   child {node {BB}}\n   child {node {BC}}\n }\n child {node {C}\n   child {node {CA}}\n   child {node {CB}}\n   child {node {CC}}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\n\\pause\\alert{Examples}\\vspace*{-0.2cm}\n\n * PBS sales by ATC groups\n * Tourism demand by states, zones, regions\n\n## Australian tourism\n\\full{regions1_with_labels}\n\n## Australian tourism\n\\fontsize{11}{12}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntourism\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 24,320 x 5 [1Q]\n# Key:       Region, State, Purpose [304]\n   Quarter Region   State Purpose  Trips\n     <qtr> <chr>    <chr> <chr>    <dbl>\n 1 1998 Q1 Adelaide SA    Business  135.\n 2 1998 Q2 Adelaide SA    Business  110.\n 3 1998 Q3 Adelaide SA    Business  166.\n 4 1998 Q4 Adelaide SA    Business  127.\n 5 1999 Q1 Adelaide SA    Business  137.\n 6 1999 Q2 Adelaide SA    Business  200.\n 7 1999 Q3 Adelaide SA    Business  169.\n 8 1999 Q4 Adelaide SA    Business  134.\n 9 2000 Q1 Adelaide SA    Business  154.\n10 2000 Q2 Adelaide SA    Business  169.\n# i 24,310 more rows\n```\n:::\n:::\n\n\n## Australian tourism\n\n\\begin{textblock}{10}(1,1.5)\\fontsize{11}{12}\\sf\n\\begin{block}{}\n  \\begin{itemize}\\itemsep=0cm\\parskip=0cm\n    \\item Quarterly data on visitor night from 1998:Q1 -- 2013:Q4\n    \\item From: \\textit{National Visitor Survey}, based on annual interviews of 120,000 Australians aged 15+, collected by Tourism Research Australia.\n    \\item Split by 7 states, 27 zones and 76 regions (a geographical hierarchy)\n    \\item Also split by purpose of travel\n      \\begin{itemize}\n        \\item Holiday\n        \\item Visiting friends and relatives (VFR)\n        \\item Business\n        \\item Other\n      \\end{itemize}\n    \\item 304 bottom-level series\n  \\end{itemize}\n\\end{block}\n\\end{textblock}\n\n## Grouped time series\n\\fontsize{13}{14}\\sf\n\nA \\alert{\\textbf{grouped time series}} is a collection of time series that can be grouped together in a number of non-hierarchical ways.\n\n\\begin{minipage}{9.2cm}\n\\begin{block}{}\n\\begin{tikzpicture}[level distance=1.5cm]\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]\n\\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AX}}\n   child {node {AY}}\n }\n child {node {B}\n   child {node {BX}}\n   child {node {BY}}\n };\n\\end{tikzpicture}\\hspace*{1cm}\n\\begin{tikzpicture}[level distance=1.5cm]\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]\n\\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]\n\\node{Total}[edge from parent fork down]\n child {node {X}\n   child {node {AX}}\n   child {node {BX}}\n }\n child {node {Y}\n   child {node {AY}}\n   child {node {BY}}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\n\\pause\\alert{Examples}\n\n * Tourism by state and purpose of travel\n * Retail sales by product groups/sub groups, and by countries/regions\n\n## Creating aggregates\n\\fontsize{7}{7}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPBS |>\n  aggregate_key(ATC1 / ATC2, Scripts = sum(Scripts)) |>\n  filter(Month == yearmonth(\"1991 Jul\")) |>\n  print(n = 18)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 98 x 4 [1M]\n# Key:       ATC1, ATC2 [98]\n      Month ATC1         ATC2         Scripts\n      <mth> <chr*>       <chr*>         <dbl>\n 1 1991 Jul <aggregated> <aggregated> 8090395\n 2 1991 Jul A            <aggregated>  799025\n 3 1991 Jul B            <aggregated>  109227\n 4 1991 Jul C            <aggregated> 1794995\n 5 1991 Jul D            <aggregated>  299779\n 6 1991 Jul G            <aggregated>  300931\n 7 1991 Jul H            <aggregated>  112114\n 8 1991 Jul J            <aggregated> 1151681\n 9 1991 Jul L            <aggregated>   24580\n10 1991 Jul M            <aggregated>  562956\n11 1991 Jul N            <aggregated> 1546023\n12 1991 Jul P            <aggregated>   47661\n13 1991 Jul R            <aggregated>  859273\n14 1991 Jul S            <aggregated>  391639\n15 1991 Jul V            <aggregated>   38705\n16 1991 Jul Z            <aggregated>   51806\n17 1991 Jul A            A01            22615\n18 1991 Jul A            A02           299251\n# i 80 more rows\n```\n:::\n:::\n\n\n## Creating aggregates\n\\fontsize{8}{8}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntourism |>\n  aggregate_key(Purpose * (State / Region), Trips = sum(Trips)) |>\n  filter(Quarter == yearquarter(\"1998 Q1\")) |>\n  print(n = 15)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 425 x 5 [1Q]\n# Key:       Purpose, State, Region [425]\n   Quarter Purpose      State        Region          Trips\n     <qtr> <chr*>       <chr*>       <chr*>          <dbl>\n 1 1998 Q1 <aggregated> <aggregated> <aggregated>   23182.\n 2 1998 Q1 Business     <aggregated> <aggregated>    3599.\n 3 1998 Q1 Holiday      <aggregated> <aggregated>   11806.\n 4 1998 Q1 Other        <aggregated> <aggregated>     680.\n 5 1998 Q1 Visiting     <aggregated> <aggregated>    7098.\n 6 1998 Q1 <aggregated> ACT          <aggregated>     551.\n 7 1998 Q1 <aggregated> NSW          <aggregated>    8040.\n 8 1998 Q1 <aggregated> NT           <aggregated>     181.\n 9 1998 Q1 <aggregated> QLD          <aggregated>    4041.\n10 1998 Q1 <aggregated> SA           <aggregated>    1735.\n11 1998 Q1 <aggregated> TAS          <aggregated>     982.\n12 1998 Q1 <aggregated> VIC          <aggregated>    6010.\n13 1998 Q1 <aggregated> WA           <aggregated>    1641.\n14 1998 Q1 <aggregated> ACT          Canberra         551.\n15 1998 Q1 <aggregated> NSW          Blue Mountains   196.\n# i 410 more rows\n```\n:::\n:::\n\n\n## Creating aggregates\n\\fontsize{13}{15}\\sf\n\n * Similar to `summarise()` but using the key structure\n * A grouped structure is specified using `grp1 * grp2`\n * A nested structure is specified via `parent / child`.\n * Groups and nesting can be mixed:\n\n    ```r\n    (country/region/city) * (brand/product)\n    ```\n\n * All possible aggregates are produced.\n * These are useful when forecasting at different levels of aggregation.\n\n# Forecast reconciliation\n\n## The problem\n\\fontsize{13}{14}\\sf\n\n\\begin{alertblock}{}\n\\begin{enumerate}\\tightlist\n \\item How to forecast time series at all nodes such that the forecasts add up in the same way as the original data?\n \\item Can we exploit relationships between the series to improve the forecasts?\n\\end{enumerate}\n\\end{alertblock}\\pause\n\n### The solution\n\n1. Forecast all series at all levels of aggregation using an automatic forecasting algorithm.\\newline (e.g., `ETS`, `ARIMA`, ...)\n2. Reconcile the resulting forecasts so they add up correctly using least squares optimization (i.e., find closest reconciled forecasts to the original forecasts).\n3. This is available using `reconcile()`.\n\n## Forecast reconciliation\n\\fontsize{9}{10}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntourism |>\n  aggregate_key(Purpose * (State / Region), Trips = sum(Trips)) |>\n  model(ets = ETS(Trips)) |>\n  reconcile(ets_adjusted = min_trace(ets)) |>\n  forecast(h = 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A fable: 1,700 x 7 [1Q]\n# Key:     Purpose, State, Region, .model [850]\n   Purpose  State  Region         .model       Quarter        Trips .mean\n   <chr*>   <chr*> <chr*>         <chr>          <qtr>       <dist> <dbl>\n 1 Business ACT    Canberra       ets          2018 Q1 N(144, 1119) 144. \n 2 Business ACT    Canberra       ets          2018 Q2 N(203, 2260) 203. \n 3 Business ACT    Canberra       ets_adjusted 2018 Q1  N(157, 539) 157. \n 4 Business ACT    Canberra       ets_adjusted 2018 Q2  N(214, 951) 214. \n 5 Business ACT    <aggregated>   ets          2018 Q1 N(144, 1119) 144. \n 6 Business ACT    <aggregated>   ets          2018 Q2 N(203, 2260) 203. \n 7 Business ACT    <aggregated>   ets_adjusted 2018 Q1  N(157, 539) 157. \n 8 Business ACT    <aggregated>   ets_adjusted 2018 Q2  N(214, 951) 214. \n 9 Business NSW    Blue Mountains ets          2018 Q1   N(20, 140)  19.7\n10 Business NSW    Blue Mountains ets          2018 Q2   N(20, 140)  19.7\n# i 1,690 more rows\n```\n:::\n:::\n\n\n## Hierarchical and grouped time series\n\nEvery collection of time series with aggregation constraints can be written as\n\\begin{block}{}\n\\centerline{$\\by_{t}=\\bS\\bm{b}_{t}$}\n\\end{block}\nwhere\n\n * $\\by_t$ is a vector of all series at time $t$\n * $\\bm{b}_t$ is a vector of the most disaggregated series at time $t$\n * $\\bS$ is a ``summing matrix'' containing the aggregation constraints.\n\n## Hierarchical time series\n\n\\begin{minipage}{4cm}\\vspace*{0.2cm}\n\\begin{block}{}\\centering\n\\begin{tikzpicture}\n\\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]\n\\tikzstyle[level distance=.3cm]\n\\tikzstyle[sibling distance=12cm]\n\\tikzstyle{level 1}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n }\n child {node {B}\n }\n child {node {C}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\n\\only<2->{\\begin{textblock}{6.3}(6,1)\\small\n\\begin{itemize}\\itemsep=0cm\\parskip=0cm\n\\item[$ y_{t}: $] observed aggregate of all series at time\n$t$.\n\\item[$ y_{X,t}: $] observation on series $X$ at time $t$.\n\\item[$ \\bm{b}_{t}: $] vector of all series at bottom level\nin time $t$.\n\\end{itemize}\n\\end{textblock}}\\vspace*{0.6cm}\n\\only<3->{\n$\\bY_{t}= \\begin{pmatrix}\n  y_{t}\\\\\n  y_{A,t}\\\\\n  y_{B,t}\\\\\n  y_{C,t}\n  \\end{pmatrix} = \\only<3>{\\hspace*{0.01cm}\\begin{pmatrix}\n                1 & 1 & 1 \\\\\n                1 & 0 & 0 \\\\\n                0 & 1 & 0\\\\\n                0 & 0 & 1\n                \\end{pmatrix}}\\only<4->{{\\color{blue}\\underbrace{\\begin{pmatrix}\n                1 & 1 & 1 \\\\\n                1 & 0 & 0 \\\\\n                0 & 1 & 0\\\\\n                0 & 0 & 1\n                \\end{pmatrix}}_{\\bS}}}\\only<3>{\\hspace*{0.08cm}}\\only<3>{\\hspace*{-0.1cm}\\begin{pmatrix}y_{A,t}\\\\y_{B,t}\\\\y_{C,t}\\end{pmatrix}}\\rule{0cm}{1.6cm}\n                \\only<4->{\\hspace*{0.08cm}{\\color{red}\\underbrace{\\begin{pmatrix}y_{A,t}\\\\y_{B,t}\\\\y_{C,t}\\end{pmatrix}}_{\\bm{b}_{t}}}}$}\n\n\\vspace*{-0.6cm}\n\n\\only<4>{\\hspace*{8cm}\\colorbox[RGB]{210,210,210}{$\\bY_{t}=\\color{blue}\\bS\\color{red}\\bm{b}_{t}$}}\n\n\\vspace*{10cm}\n\n## Forecasting notation\n\nLet $\\hat{\\by}_n(h)$ be vector of initial $h$-step forecasts, made at time $n$, stacked in same order as $\\by_t$. \\pause\\newline  (In general, they will not ``add up''.)\\pause\n\n\\begin{block}{}\nReconciled forecasts must be of the form:\n$$\\tilde{\\by}_{n}(h)=\\bS\\bm{G}\\hat{\\by}_{n}(h)$$\nfor some matrix $\\bm{G}$.\n\\end{block}\\pause\n\n * $\\bm{G}$ extracts and combines base forecasts $\\hat{\\by}_{n}(h)$ to get bottom-level forecasts.\n * $\\bS$ adds them up\n\n## Optimal combination forecasts\n\\fontsize{13}{14}\\sf\n\n\\begin{alertblock}{Main result}\nThe best (minimum sum of variances) unbiased forecasts are obtained when\n$\\bm{G} = (\\bS'\\bW^{-1}_{h}\\bS)^{-1}\\bS'\\bW^{-1}_{h}$,\nwhere $\\bW_h$ is the $h$-step base forecast error covariance matrix.\n\\end{alertblock}\n\n\\pause\n\n\\begin{block}{}\n\\centerline{$\\displaystyle\\textcolor{red}{\\tilde{\\by}_{n}(h)}\n=\\bS(\\bS'\\bW^{-1}_{h}\\bS)^{-1}\\bS'\\bW^{-1}_{h}\\textcolor{blue}{\\hat{\\by}_{n}(h)}$}\n\\end{block}\\fontsize{14}{15}\\sf\n\n\\alert{\\textbf{Problem:}} $\\bW_h$ hard to estimate, especially for $h>1$.\n\n\\alert{Solutions:}\\vspace*{-0.4cm}\n\n * Ignore $\\bW_h$ (OLS) [`min_trace(method='ols')`]\n * Assume $\\bW_h = k_h\\bW_1$ is diagonal (WLS) [`min_trace(method='wls')`]\n * Assume $\\bW_h = k_h\\bW_1$ and estimate it (GLS) [`min_trace(method='shrink')` (the default)]\n\n## Features\n\\fontsize{15}{17}\\sf\n\n * Covariates can be included in initial forecasts.\n * Adjustments can be made to initial forecasts at any level.\n * Very simple and flexible method. Can work with *any* hierarchical or grouped time series.\n * Conceptually easy to implement: regression of base forecasts on structure matrix.\n\n# Example: Australian tourism\n\n## Example: Australian tourism\n\\fontsize{12}{13}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntourism_agg <- tourism |>\n  aggregate_key(Purpose * (State / Region),\n    Trips = sum(Trips)\n  )\nfc <- tourism_agg |>\n  filter_index(. ~ \"2015 Q4\") |>\n  model(ets = ETS(Trips)) |>\n  reconcile(ets_adjusted = min_trace(ets)) |>\n  forecast(h = \"2 years\")\n```\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(Purpose) & is_aggregated(State)) |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism2-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(Purpose) & State == \"VIC\" &\n    is_aggregated(Region)) |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism3-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(Purpose) & Region == \"Melbourne\") |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism4-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(Purpose) & Region == \"Snowy Mountains\") |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism5-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(Purpose == \"Holiday\" & Region == \"Barossa\") |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism6-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(Purpose) & Region == \"MacDonnell\") |>\n  autoplot(tourism_agg, level = 95)\n```\n\n::: {.cell-output-display}\n![](10-reconciliation_files/figure-beamer/fctourism7-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{12}{12.5}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc <- tourism_agg |>\n  filter_index(. ~ \"2015 Q4\") |>\n  model(\n    ets = ETS(Trips),\n    arima = ARIMA(Trips)\n  ) |>\n  mutate(\n    comb = (ets + arima) / 2\n  ) |>\n  reconcile(\n    ets_adj = min_trace(ets),\n    arima_adj = min_trace(arima),\n    comb_adj = min_trace(comb)\n  ) |>\n  forecast(h = \"2 years\")\n```\n:::\n\n\n## Forecast evaluation\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |> accuracy(tourism_agg)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,550 x 13\n   .model Purpose  State  Region               .type    ME  RMSE   MAE   MPE  MAPE  MASE\n   <chr>  <chr*>   <chr*> <chr*>               <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n 1 arima  Business ACT    Canberra           ~ Test  35.9   45.7 35.9   16.9  16.9 0.938\n 2 arima  Business ACT    <aggregated>         Test  35.9   45.7 35.9   16.9  16.9 0.938\n 3 arima  Business NSW    Blue Mountains     ~ Test   1.93  10.6  8.52 -18.0  48.6 0.644\n 4 arima  Business NSW    Capital Country    ~ Test   8.08  15.6 10.4   11.8  19.0 0.744\n 5 arima  Business NSW    Central Coast      ~ Test  10.0   14.5 10.8   26.9  32.2 0.982\n 6 arima  Business NSW    Central NSW        ~ Test  17.7   31.9 28.2   12.0  24.1 1.08 \n 7 arima  Business NSW    Hunter             ~ Test  35.3   43.9 35.3   24.2  24.2 1.30 \n 8 arima  Business NSW    New England North W~ Test  23.1   31.8 26.8   19.5  28.0 1.76 \n 9 arima  Business NSW    North Coast NSW    ~ Test  24.8   40.1 36.8   11.5  28.5 1.38 \n10 arima  Business NSW    Outback NSW        ~ Test   6.87  11.0  7.76  13.7  16.5 0.571\n# i 2,540 more rows\n# i 2 more variables: RMSSE <dbl>, ACF1 <dbl>\n```\n:::\n:::\n\n\n## Forecast evaluation\n\\fontsize{12}{13}\\sf\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc |>\n  accuracy(tourism_agg) |>\n  group_by(.model) |>\n  summarise(MASE = mean(MASE)) |>\n  arrange(MASE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 x 2\n  .model     MASE\n  <chr>     <dbl>\n1 ets_adj    1.02\n2 comb_adj   1.02\n3 ets        1.04\n4 comb       1.04\n5 arima_adj  1.07\n6 arima      1.09\n```\n:::\n:::\n\n\n# Lab Session 20\n\n## Lab Session 20\n\n* Prepare aggregations of the PBS data by Concession, Type, and ATC1.\n* Use forecast reconciliation with the PBS data, using ETS, ARIMA and SNAIVE models, applied to all but the last 3 years of data.\n* Which type of model works best?\n* Does the reconciliation improve the forecast accuracy?\n* Why doesn't the reconcililation make any difference to the SNAIVE forecasts?\n\n## Feedback form\n\n\\begin{alertblock}{}\\LARGE\\bfseries\\centering\n\\href{https://bit.ly/fable2022feedback}{bit.ly/fable2022feedback}\n\\end{alertblock}\n",
    "supporting": [
      "10-reconciliation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}